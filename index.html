<!DOCTYPE html>

<html>

<head>
    <title>Курсовая</title>
    <meta charset="utf-8" />
    <script type="text/javascript" src="./three.min.js"></script>
    <script type="text/javascript" src="./lib/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="./lib/PointerLockControls.js"></script>
    <script src='objects.json'> </script>
    <script src='transform.js'> </script>
    <script src='events.js'> </script>
    <style>
        body{
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div id="Stats-output">
</div>
<!-- Div which will hold the Output -->
<div id="WebGL-output">
</div>
<!-- Javascript code that runs our Three.js examples -->
<script type="text/javascript">

    var camera;
    var vector = new THREE.Vector3( 0, 0, -1 );
    var controls;
    var obj3 = new THREE.Object3D();
    var scene = new THREE.Scene();
    var time = Math.round(new Date().getTime()/1000.0);

    // once everything is loaded, we run our Three.js stuff.
    $(function () {


        // create a scene, that will hold all our elements such as objects, cameras and lights.

        // alert("scene");
        // create a camera, which defines where we're looking at.
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.x = 120;
        camera.position.y = 60;
        camera.position.z = 180;
        // alert("camera");
        // create a render and set the size
        var renderer = new THREE.WebGLRenderer();

        renderer.setClearColor(0xEEEEEE, 1.0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        // alert("renderer");
        controls = new THREE.PointerLockControls( camera );
        scene.add( controls.getObject() );

        // create the ground plane
        var planeGeometry = new THREE.PlaneGeometry(200,200);
        var planeMaterial =    new THREE.MeshLambertMaterial({color: 0xffffff});
        var plane = new THREE.Mesh(planeGeometry,planeMaterial);

        // alert("plane");
        // rotate and position the plane
        plane.rotation.x=-0.5*Math.PI;
        plane.position.x=0
        plane.position.y=0
        plane.position.z=0

        // add the plane to the scene
        scene.add(plane);

        jQuery.ajax({
          type:'GET',
          url: pathOfObjects,
          contentType: "application/json",
          dataType: "jsonp",
          crossDomain: true,
          cache: true,
            error:function(d, textStatus, error) {
            alert("Загрузка данных стоек закончилась неудачей, status: " + textStatus + ", error: "+error);
            },
            success:function(json,textStatus,jqHXR) {
	       		   var cubeGeometry = new THREE.CubeGeometry(4,8,4);
			 	       var cubeMaterial = new THREE.MeshLambertMaterial({color: defaultColor});
      		     for (var j = 0 ; j < json.data.length ; j++) {
        		       var pos = transformid(json.data[j]);
        		       var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
	                 cube.position.z=pos[2];
	                 cube.position.x=pos[0];
	                 cube.position.y=pos[1];
	                 cube.name = getName(json.data[j]);
	                 scene.add(cube);
                   loadGraph(json.data[j]);
		      }



		      }});


        var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.3 );
        directionalLight.position.set( -20, 40, 60 );
        scene.add(directionalLight);

        var directionalLight2 = new THREE.DirectionalLight( 0xffffff, 0.15 );
        directionalLight.position.set( 20, 40, -60 );
        scene.add(directionalLight2);

        var directionalLight3 = new THREE.DirectionalLight( 0xffffff, 0.07 );
        directionalLight.position.set( 30, 20, -160 );
        scene.add(directionalLight3);

        var directionalLight4 = new THREE.DirectionalLight( 0xffffff, 0.1 );
        directionalLight.position.set( 30, 20, 160 );
        scene.add(directionalLight4);


        // add subtle ambient lighting
        var ambientLight = new THREE.AmbientLight(0x292929);
        scene.add(ambientLight);

        // add the output of the renderer to the html element
        $("#WebGL-output").append(renderer.domElement);

        var step=0;

        camera.lookAt(new THREE.Vector3(0,60,0));
        render();

        function render() {

          if (Math.round(new Date().getTime()/1000.0) - time > frequencyOfRequests)
          {

          jQuery.ajax({
            type:'GET',
            url: pathOfRequest,
            contentType: "application/json",
            dataType: "jsonp",
            crossDomain: true,
	          cache: true,
            error:function(d, textStatus, error) {
              alert("Загрузка данных не вышла, status: " + textStatus + ", error: "+error);
            },
            success: function(json) {
              // console.log(json.data.length);
              var lng = json.data.length;
              for (var i = 0; i < lng; i++)
              {
                if (getTimeOfError(json.data[i]) > time)
                {
                  var col;
                  var erst = getErrorStatus(json.data[i]);
                  if (erst in statuses) {
                    col = statuses[erst];
                  } else {
                    col = defaultColor;
                  }
                  var objEr = getErrorObjName(json.data[i]);
                  console.log("Имя объекта: ",objEr);
                  showError(objEr,col);
                }
              }
            }
          });

          time = Math.round(new Date().getTime()/1000.0);
        }

            requestAnimationFrame(render);
            renderer.render(scene, camera);
          }

    });



</script>
</body>
</html>
